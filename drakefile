import drake
import drake.cxx
import drake.cxx.boost
import os
import sys

from itertools import chain

config = None
elle = None
cryptography = None
protocol = None
reactor = None
asio_udt = None
aws = None
rule_check = None
rule_tests = None

curl_config = None
curl_lib = None

openssl_config = None
openssl_lib_ssl = None
openssl_lib_crypto = None

zlib_config = None
zlib_lib = None

python_config = None
python_lib = None

with open(str(drake.path_source('drake-utils.py')), 'r') as f:
  exec(f.read(), globals(), globals())

def configure(cxx_toolkit = None,
              cxx_config = drake.cxx.Config(),
              boost = None,
              enable_rotation = False,
              dopenssl = None,
              prefix = '/usr',
              valgrind = None):

  global config
  global elle
  global cryptography
  global protocol
  global reactor
  global asio_udt
  global aws

  global curl_config, curl_lib
  global openssl_config, openssl_lib_ssl, openssl_lib_crypto
  global zlib_config, zlib_lib
  global python_config, python_lib

  config = drake.cxx.Config()

  cxx_config = drake.cxx.Config(cxx_config)
  cxx_toolkit = cxx_toolkit or drake.cxx.Toolkit()
  boost = drake.cxx.boost.find(
    boost,
    cxx_toolkit = cxx_toolkit,
    version = drake.Version(1, drake.Range(54, None)))

  prefix = drake.Path(prefix)
  if not prefix.absolute():
    prefix = drake.Path('..') / prefix

  ## ---- ##
  ## Zlib ##
  ## ---- ##

  zlib_version = '1.2.8'
  zlib_basename = 'zlib-%s' % zlib_version
  zlib_tarball = drake.node('zlib/%s.tar.gz' % zlib_basename)
  zlib_prefix = drake.Path('zlib')
  zlib_build = zlib_prefix / zlib_basename
  zlib_configure = drake.node(zlib_build / 'configure')
  # This url does not work due to Apache messing up with content-type
  # headers:
  # zlib_url = 'http://zlib.net/%s.tar.gz' % zlib_basename
  zlib_url = 'http://downloads.sourceforge.net/project/libpng/zlib/%s/%s.tar.gz' % (
    zlib_version,
    zlib_basename,
  )
  drake.HTTPDownload(
    zlib_url,
    zlib_tarball,
    fingerprint = '44d667c142d7cda120332623eab69f40'
  )
  drake.TarballExtractor(
    zlib_tarball,
    targets = ['%s/%s' % (zlib_basename, 'configure')],
  )

  if cxx_toolkit.os is drake.os.windows:
    # XXX only for mingw
    zlib_makefile = 'win32/Makefile.gcc'
    zlib_lib = drake.cxx.StaticLib('zlib/lib/libz.a')
    zlib_configure_call = None
    zlib_configure_args = ['--static']
  else:
    zlib_makefile = None
    zlib_configure_call = zlib_configure
    zlib_configure_args = []
    if cxx_toolkit.os is drake.os.macos:
      zlib_lib = drake.cxx.DynLib('zlib/lib/libz.1.2.8.dylib')
    elif cxx_toolkit.os is drake.os.linux:
      zlib_lib = drake.cxx.DynLib('zlib/lib/libz.so.1')
  zlib_libs = [zlib_lib,]

  zlib_prefix_absolute = drake.path_build(zlib_prefix,
                                          absolute = True)
  GNUBuilder(
    cxx_toolkit,
    configure = zlib_configure_call,
    configure_args = [
      '--prefix=%s' % zlib_prefix_absolute,
    ] + zlib_configure_args,
    additional_env = {
      'CFLAGS': '-fPIC',
    },
    working_directory = drake.path_build(zlib_build),
    targets = zlib_libs + drake.nodes('zlib/include/zlib.h',
                                      'zlib/include/zconf.h'),
    makefile = zlib_makefile,
    sources = [zlib_configure],
    build_args = ['install'] + list(s.replace('\\', '/') for s in [
      "INCLUDE_PATH='%s/include'" % zlib_prefix_absolute,
      "BINARY_PATH='%s/bin'" % zlib_prefix_absolute,
      "LIBRARY_PATH='%s/lib'" % zlib_prefix_absolute,
      "PREFIX=%s" % cxx_toolkit.prefix,
    ])
  )
  zlib_config = drake.cxx.Config()
  zlib_config.add_local_include_path('zlib/include')

  ## ------- ##
  ## OpenSSL ##
  ## ------- ##

  openssl_basename = 'openssl-1.0.1f'
  openssl_tarball = drake.node('openssl/%s.tar.gz' % openssl_basename)
  openssl_prefix = drake.Path('openssl')
  openssl_build = openssl_prefix / openssl_basename
  openssl_url = \
    'http://www.openssl.org/source/%s.tar.gz' % openssl_basename
  drake.HTTPDownload(openssl_url, openssl_tarball,
                     fingerprint = 'f26b09c028a0541cab33da697d522b25')
  openssl_headers = [
    'include/openssl/aes.h',
    'include/openssl/asn1.h',
    'include/openssl/asn1_mac.h',
    'include/openssl/asn1t.h',
    'include/openssl/bio.h',
    'include/openssl/blowfish.h',
    'include/openssl/bn.h',
    'include/openssl/buffer.h',
    'include/openssl/camellia.h',
    'include/openssl/cast.h',
    'include/openssl/cmac.h',
    'include/openssl/cms.h',
    'include/openssl/comp.h',
    'include/openssl/conf.h',
    'include/openssl/conf_api.h',
    'include/openssl/crypto.h',
    'include/openssl/des.h',
    'include/openssl/des_old.h',
    'include/openssl/dh.h',
    'include/openssl/dsa.h',
    'include/openssl/dso.h',
    'include/openssl/dtls1.h',
    'include/openssl/e_os2.h',
    'include/openssl/ebcdic.h',
    'include/openssl/ec.h',
    'include/openssl/ecdh.h',
    'include/openssl/ecdsa.h',
    'include/openssl/engine.h',
    'include/openssl/err.h',
    'include/openssl/evp.h',
    'include/openssl/hmac.h',
    'include/openssl/idea.h',
    'include/openssl/krb5_asn.h',
    'include/openssl/kssl.h',
    'include/openssl/lhash.h',
    'include/openssl/md4.h',
    'include/openssl/md5.h',
    'include/openssl/mdc2.h',
    'include/openssl/modes.h',
    'include/openssl/obj_mac.h',
    'include/openssl/objects.h',
    'include/openssl/ocsp.h',
    'include/openssl/opensslconf.h',
    'include/openssl/opensslv.h',
    'include/openssl/ossl_typ.h',
    'include/openssl/pem.h',
    'include/openssl/pem2.h',
    'include/openssl/pkcs12.h',
    'include/openssl/pkcs7.h',
    'include/openssl/pqueue.h',
    'include/openssl/rand.h',
    'include/openssl/rc2.h',
    'include/openssl/rc4.h',
    'include/openssl/ripemd.h',
    'include/openssl/rsa.h',
    'include/openssl/safestack.h',
    'include/openssl/seed.h',
    'include/openssl/sha.h',
    'include/openssl/srp.h',
    'include/openssl/srtp.h',
    'include/openssl/ssl.h',
    'include/openssl/ssl2.h',
    'include/openssl/ssl23.h',
    'include/openssl/ssl3.h',
    'include/openssl/stack.h',
    'include/openssl/symhacks.h',
    'include/openssl/tls1.h',
    'include/openssl/ts.h',
    'include/openssl/txt_db.h',
    'include/openssl/ui.h',
    'include/openssl/ui_compat.h',
    'include/openssl/whrlpool.h',
    'include/openssl/x509.h',
    'include/openssl/x509_vfy.h',
    'include/openssl/x509v3.h',
  ]
  drake.TarballExtractor(
    openssl_tarball,
    targets = ['%s/%s' % (openssl_basename, f)
               for f in ['Configure'] + openssl_headers])
  openssl_configure = drake.node(openssl_build / 'Configure')
  from drake.cxx import DynLib, StaticLib
  openssl_shared = True
  if cxx_toolkit.os is drake.os.linux:
    openssl_lib_ssl = DynLib(openssl_prefix / 'lib/libssl.so.1.0.0')
    openssl_lib_crypto = DynLib(openssl_prefix / 'lib/libcrypto.so.1.0.0')
  elif cxx_toolkit.os is drake.os.macos:
    openssl_lib_ssl = DynLib(openssl_prefix / 'lib/libssl.1.0.0.dylib')
    openssl_lib_crypto = DynLib(openssl_prefix / 'lib/libcrypto.1.0.0.dylib')
  elif cxx_toolkit.os is drake.os.windows:
    openssl_lib_ssl = StaticLib(openssl_prefix / 'lib/libssl.a')
    openssl_lib_crypto = StaticLib(openssl_prefix / 'lib/libcrypto.a')
    openssl_shared = False
  openssl_libs = [openssl_lib_ssl, openssl_lib_crypto]
  if cxx_toolkit.os is drake.os.linux:
    os_string = 'linux-x86_64'
  elif cxx_toolkit.os is drake.os.windows:
    os_string = 'mingw64'
  elif cxx_toolkit.os is drake.os.macos:
    os_string = 'darwin64-x86_64-cc'
  GNUBuilder(
    cxx_toolkit,
    configure = openssl_configure,
    configure_interpreter = 'perl',
    targets = chain(openssl_libs,
                    (drake.node(openssl_prefix / p)
                     for p in openssl_headers)),
    configure_args = [
      '--prefix=%s' % drake.path_build(openssl_prefix,
                                       absolute = True),
      openssl_shared and 'shared' or 'no-shared',
      'no-asm',
      '-DPURIFY',
      os_string,
    ],
    build_args = [
    'all', 'install',
    ],
    additional_env = {
        'PERL': 'perl',
        'CC': cxx_toolkit.c,
    },
    patch = drake.node('openssl.patch'),
  )
  openssl_config = drake.cxx.Config()
  openssl_config.add_local_include_path(openssl_prefix / 'include')

  ## ---- ##
  ## Curl ##
  ## ---- ##

  curl_basename = 'curl-7.35.0'
  curl_tarball = drake.node('curl/%s.tar.gz' % curl_basename)
  curl_prefix = drake.Path('curl')
  curl_build = curl_prefix / curl_basename
  curl_url = 'http://curl.haxx.se/download/%s.tar.gz' % curl_basename
  drake.HTTPDownload(curl_url, curl_tarball,
                     fingerprint = 'f5ae45ed6e86debb721b68392b5ce13c')
  drake.TarballExtractor(
    curl_tarball,
    targets = ['%s/%s' % (curl_basename, f) for f in (
      'configure',
    )]
  )
  curl_configure = drake.node(curl_build / 'configure')
  from drake.cxx import DynLib, StaticLib
  if cxx_toolkit.os is drake.os.linux:
    curl_lib = DynLib(curl_prefix / 'lib/libcurl.so.4')
  elif cxx_toolkit.os is drake.os.macos:
    curl_lib = DynLib(curl_prefix / 'lib/libcurl.4.dylib')
  elif cxx_toolkit.os is drake.os.windows:
    curl_lib = StaticLib(curl_prefix / 'lib/libcurl.a')
  else:
    raise Exception('Unknown OS')

  curl_openssl_libs = drake.copy(openssl_libs, curl_prefix / 'lib',
                                 strip_prefix = True)
  curl_zlib_libs = drake.copy(zlib_libs, curl_prefix / 'lib',
                              strip_prefix = True)
  curl_configure_args = [
    '--prefix=%s' % drake.path_build(curl_prefix, absolute = True),
    '--with-ssl=%s' % drake.path_build(openssl_prefix,
                                       absolute = True),
    '--with-zlib=%s' % drake.path_build(zlib_prefix,
                                        absolute = True),
    '--enable-hidden-symbols',
    '--enable-optimize',
    '--enable-warnings',
    '--enable-threaded-resolver',
    '--disable-ldap',
    '--disable-ldaps',
    '--disable-rtmp',
    '--disable-sspi',
    '--disable-ssh',
    '--disable-rtsp',
    '--with-gssapi',
    '--without-libidn',
  ]
  if isinstance(curl_lib, StaticLib):
    curl_configure_args.extend([
      '--disable-shared',
      '--enable-static',
    ])
  else:
    curl_configure_args.extend([
      '--enable-shared',
      '--disable-static',
    ])
  # if cxx_toolkit.os is drake.os.linux:
  #   # So curl links its curl binary with the right SSL.
  #   curl_configure_args.append(
  #     'LDFLAGS=-Wl,-rpath-link,%s -ldl' % (openssl_prefix / 'lib'))
  curl_environment = {}
  if cxx_toolkit.os is drake.os.macos:
    key = 'DYLD_FALLBACK_LIBRARY_PATH'
    path = drake.path_build(zlib_prefix, absolute = True) / 'lib'
    curl_environment[key] = str(path)
  elif cxx_toolkit.os is drake.os.windows:
    curl_environment['CC'] = cxx_toolkit.c
    curl_configure_args.append('--host=%s' % cxx_toolkit.prefix)
  curl_dependency_libs = curl_openssl_libs + curl_zlib_libs
  GNUBuilder(
    cxx_toolkit,
    configure = curl_configure,
    working_directory = drake.path_build(curl_build),
    targets = [curl_lib] +
      drake.nodes(*(curl_prefix / path for path in
                    ('include/curl/typecheck-gcc.h',
                     'include/curl/stdcheaders.h',
                     'include/curl/easy.h',
                     'include/curl/mprintf.h',
                     'include/curl/curl.h',
                     'include/curl/curlver.h',
                     'include/curl/multi.h',
                     'include/curl/curlrules.h'))),
    configure_args = curl_configure_args,
    sources = curl_dependency_libs + [curl_configure],
    build_args = ['all', 'install',],
    additional_env = curl_environment,
  )
  for lib in curl_dependency_libs:
    curl_lib.dependency_add(lib)
  curl_config = drake.cxx.Config()
  curl_config.add_local_include_path(curl_prefix / 'include')
  if cxx_toolkit.os is drake.os.windows:
    curl_config.define('CURL_STATICLIB', '1')

  ## ------ ##
  ## Python ##
  ## ------ ##
  python_version = '3.3.5'
  python_basename = 'Python-%s' % python_version
  python_tarball_extension = 'tar.xz'
  python_tarball = drake.node('python/%s.%s' % (python_basename,
                                                 python_tarball_extension))
  python_prefix = drake.Path('python')
  python_build = python_prefix / python_basename
  # XXX: Use legacy.python.org because python.org is on https.
  python_url = 'http://legacy.python.org/ftp/python/%s/%s.%s' % \
                  (
                    python_version,
                    python_basename.capitalize(),
                    python_tarball_extension
                  )
  drake.HTTPDownload(python_url,
                     python_tarball,
                     fingerprint = 'b2a4df195d934e5b229e8328ca864960')

  python_headers = [
    'Include/abstract.h',
    'Include/accu.h',
    'Include/asdl.h',
    'Include/ast.h',
    'Include/bitset.h',
    'Include/bltinmodule.h',
    'Include/boolobject.h',
    'Include/bytearrayobject.h',
    'Include/bytes_methods.h',
    'Include/bytesobject.h',
    'Include/cellobject.h',
    'Include/ceval.h',
    'Include/classobject.h',
    'Include/codecs.h',
    'Include/code.h',
    'Include/compile.h',
    'Include/complexobject.h',
    'Include/datetime.h',
    'Include/descrobject.h',
    'Include/dictobject.h',
    'Include/dtoa.h',
    'Include/dynamic_annotations.h',
    'Include/enumobject.h',
    'Include/errcode.h',
    'Include/eval.h',
    'Include/fileobject.h',
    'Include/fileutils.h',
    'Include/floatobject.h',
    'Include/frameobject.h',
    'Include/funcobject.h',
    'Include/genobject.h',
    'Include/graminit.h',
    'Include/grammar.h',
    'Include/import.h',
    'Include/intrcheck.h',
    'Include/iterobject.h',
    'Include/listobject.h',
    'Include/longintrepr.h',
    'Include/longobject.h',
    'Include/marshal.h',
    'Include/memoryobject.h',
    'Include/metagrammar.h',
    'Include/methodobject.h',
    'Include/modsupport.h',
    'Include/moduleobject.h',
    'Include/namespaceobject.h',
    'Include/node.h',
    'Include/object.h',
    'Include/objimpl.h',
    'Include/opcode.h',
    'Include/osdefs.h',
    'Include/parsetok.h',
    'Include/patchlevel.h',
    'Include/pgen.h',
    'Include/pgenheaders.h',
    'Include/pyarena.h',
    'Include/pyatomic.h',
    'Include/pycapsule.h',
    'Include/pyctype.h',
    'Include/py_curses.h',
    'Include/pydebug.h',
    'Include/pyerrors.h',
    'Include/pyexpat.h',
    'Include/pyfpe.h',
    'Include/pygetopt.h',
    'Include/pymacconfig.h',
    'Include/pymacro.h',
    'Include/pymath.h',
    'Include/pymem.h',
    'Include/pyport.h',
    'Include/pystate.h',
    'Include/pystrcmp.h',
    'Include/pystrtod.h',
    'Include/Python-ast.h',
    'Include/Python.h',
    'Include/pythonrun.h',
    'Include/pythread.h',
    'Include/pytime.h',
    'Include/rangeobject.h',
    'Include/setobject.h',
    'Include/sliceobject.h',
    'Include/structmember.h',
    'Include/structseq.h',
    'Include/symtable.h',
    'Include/sysmodule.h',
    'Include/token.h',
    'Include/traceback.h',
    'Include/tupleobject.h',
    'Include/typeslots.h',
    'Include/ucnhash.h',
    'Include/unicodeobject.h',
    'Include/warnings.h',
    'Include/weakrefobject.h',
  ]

  drake.TarballExtractor(
    python_tarball,
    targets = ['%s/%s' % (python_basename, f) for f in ['configure'] + python_headers])

  python_configure = drake.node(python_build / 'configure')
  from drake.cxx import DynLib, StaticLib
  if cxx_toolkit.os is drake.os.linux:
    python_lib = DynLib(python_prefix / 'lib/libpython3.so')
  elif cxx_toolkit.os is drake.os.macos:
    python_lib = DynLib(python_prefix / 'lib/libpython3.dylib')
  elif cxx_toolkit.os is drake.os.windows:
    python_lib = DynLib(python_prefix / 'lib/libpython3.dll')
  else:
    raise Exception('Unknown OS')
  python_configure_args = [
    '--prefix=%s' % drake.path_build(python_prefix, absolute = True),
    '--enable-shared',
  ]
  python_environment = {}
  python_include_dir = 'include/python3.3m'
  GNUBuilder(
    cxx_toolkit,
    configure = python_configure,
    working_directory = drake.path_build(python_build),
    targets = chain([python_lib],
                    (drake.node(python_prefix / p.replace('Include', python_include_dir))
                                for p in python_headers),
                    [drake.node(python_prefix / python_include_dir / 'pyconfig.h')]),
    configure_args = python_configure_args,
    sources = [python_configure],
    build_args = ['install',],
    additional_env = python_environment,
  )

  python_config = drake.cxx.Config()
  python_config.add_local_include_path(python_prefix / python_include_dir)

  ## ------------- ##
  ## Configuration ##
  ## ------------- ##

  cxx_config = drake.cxx.Config(cxx_config)
  if cxx_toolkit.os == drake.os.linux:
    config.define('INFINIT_LINUX')
    cxx_config.define('INFINIT_LINUX')
  elif cxx_toolkit.os == drake.os.macos:
    config.define('INFINIT_MACOSX')
    cxx_config.define('INFINIT_MACOSX')
  elif cxx_toolkit.os == drake.os.windows:
    config.define('INFINIT_WINDOWS')
    cxx_config.define('INFINIT_WINDOWS')
    cxx_config.define('BOOST_USE_WINDOWS_H')
    cxx_config.lib('shlwapi')
    cxx_config.lib('ws2_32')
    cxx_config.lib('gdi32')
    cxx_config.lib('mswsock')
  cxx_config.export_dynamic = True
  cxx_config.warnings.parentheses = False
  cxx_config.warnings.empty_body = False
  # Clang/GCC disagree on std::hash struct versus class.
  cxx_config.warnings.mismatched_tags = False
  cxx_config.warnings.missing_declarations = \
    drake.cxx.Config.Warnings.Error
  cxx_config.warnings.return_type = \
    drake.cxx.Config.Warnings.Error

  ## -------------- ##
  ## Subdirectories ##
  ## -------------- ##

  elle = drake.include(
    'elle',
    cxx_toolkit = cxx_toolkit,
    cxx_config = cxx_config,
    zlib_config = zlib_config,
    zlib_lib = zlib_lib,
    boost = boost,
    python_config = python_config,
    python_lib = python_lib,
    prefix = prefix,
    valgrind = valgrind,
  )
  cryptography = drake.include(
    'cryptography',
    cxx_toolkit = cxx_toolkit,
    cxx_config = cxx_config,
    openssl_config = openssl_config,
    openssl_lib_crypto = openssl_lib_crypto,
    openssl_lib_ssl = openssl_lib_ssl,
    enable_rotation = enable_rotation,
    dopenssl = dopenssl,
    boost = boost,
    elle = elle,
    prefix = prefix,
    valgrind = valgrind,
  )
  reactor = drake.include(
    'reactor',
    zlib_config = zlib_config,
    zlib_lib = zlib_lib,
    curl_config = curl_config,
    curl_lib = curl_lib,
    cxx_toolkit = cxx_toolkit,
    cxx_config = cxx_config,
    boost = boost,
    openssl_config = openssl_config,
    openssl_lib_crypto = openssl_lib_crypto,
    openssl_lib_ssl = openssl_lib_ssl,
    python_config = python_config,
    python_lib = python_lib,
    elle = elle,
    prefix = prefix,
    valgrind = valgrind,
  )
  protocol = drake.include(
    'protocol',
    cxx_toolkit = cxx_toolkit,
    cxx_config = cxx_config,
    boost = boost,
    cryptography = cryptography,
    elle = elle,
    reactor = reactor,
    prefix = prefix,
    valgrind = valgrind,
  )
  aws = drake.include(
    'aws',
    cxx_toolkit = cxx_toolkit,
    cxx_config = cxx_config,
    boost = boost,
    cryptography = cryptography,
    elle = elle,
    reactor = reactor,
    prefix = prefix,
    valgrind = valgrind,
  )

  config += cryptography.config
  config += elle.config
  config += protocol.config
  config += reactor.config
  config += aws.config

  asio_udt = reactor.asio_udt_lib

  build = drake.Rule('build')
  build << elle.rule_build
  build << cryptography.rule_build
  build << reactor.rule_build
  build << protocol.rule_build
  build << aws.rule_build

  global rule_tests
  rule_tests = drake.Rule('tests')
  rule_tests << elle.rule_tests
  rule_tests << cryptography.rule_tests
  rule_tests << reactor.rule_tests
  rule_tests << protocol.rule_tests
  rule_tests << aws.rule_tests

  global rule_check
  rule_check = drake.Rule('check')
  rule_check << elle.rule_check
  rule_check << cryptography.rule_check
  rule_check << reactor.rule_check
  rule_check << protocol.rule_check
  rule_check << aws.rule_check

  install = drake.Rule('install')
  install << elle.rule_install
  install << cryptography.rule_install
  install << reactor.rule_install
  install << protocol.rule_install
  install << aws.rule_install
