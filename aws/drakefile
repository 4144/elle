import drake
import drake.cxx
import drake.cxx.boost

config = None
lib_static = None
lib_dynamic = None
library = None

rule_build = None
rule_check = None
rule_install = None
rule_tests = None

def configure(cryptography,
              elle,
              reactor,
              cxx_toolkit = None,
              cxx_config = None,
              boost = None,
              stuntman = None,
              prefix = '/usr',
              valgrind = None):

  # Public C++ configuration
  global config
  config = drake.cxx.Config()
  config.add_local_include_path('src')
  config.standard = drake.cxx.Config.cxx_11

  # Boost
  boost = boost or drake.cxx.boost.Boost()
  config += boost.config()

  # Elle
  config += elle.config
  elle_library = drake.copy(elle.library, 'lib', strip_prefix = True)

  # Reactor
  config += reactor.config
  reactor_library = drake.copy(reactor.library, 'lib',
                               strip_prefix = True)

  # Cryptography
  config += cryptography.config
  cryptography_library = drake.copy(cryptography.library, 'lib',
                                    strip_prefix = True)

  # Local C++ configuration
  cxx_toolkit = cxx_toolkit or drake.cxx.Toolkit()
  local_cxx_config = drake.cxx.Config(cxx_config)
  local_cxx_config.lib_path_runtime('.')
  local_cxx_config.enable_debug_symbols()
  local_cxx_config += config

  if cxx_toolkit.os is drake.os.windows:
    local_cxx_config += boost.config_date_time(static = True)
  else:
    local_cxx_config += boost.config_date_time(link = False)
    local_cxx_config.library_add(drake.copy(boost.date_time_dynamic,
                                            'lib', strip_prefix = True))

  sources = drake.nodes(
    'src/aws/CanonicalRequest.cc',
    'src/aws/CanonicalRequest.hh',
    'src/aws/Credentials.cc',
    'src/aws/Credentials.hh',
    'src/aws/Exceptions.cc',
    'src/aws/Exceptions.hh',
    'src/aws/Keys.cc',
    'src/aws/Keys.hh',
    'src/aws/S3.cc',
    'src/aws/S3.hh',
    'src/aws/SigningKey.cc',
    'src/aws/SigningKey.hh',
    'src/aws/StringToSign.cc',
    'src/aws/StringToSign.hh',
  )

  global lib_static, lib_dynamic, library
  from itertools import chain
  lib_static = drake.cxx.StaticLib(
    'lib/aws',
    chain(sources, (elle_library, reactor_library, cryptography_library)),
    cxx_toolkit, local_cxx_config)
  lib_dynamic = drake.cxx.DynLib(
    'lib/aws',
    chain(sources, (elle_library, reactor_library, cryptography_library)),
    cxx_toolkit, local_cxx_config)

  # Build
  global rule_build
  rule_build = drake.Rule('build')
  rule_build << lib_static
  if cxx_toolkit.os != drake.os.windows:
    rule_build << lib_dynamic
    library = lib_dynamic
  else:
    library = lib_static

  # Tests
  global rule_check, rule_tests
  rule_check = drake.TestSuite('check')
  rule_tests = drake.Rule('tests')

  tests = [
    'aws_requests',
  ]

  cxx_config_tests = drake.cxx.Config(local_cxx_config)
  cxx_config_tests += boost.config_test()
  cxx_config_tests += boost.config_system()
  cxx_config_tests += boost.config_thread()
  cxx_config_tests += boost.config_signals()
  cxx_config_tests.lib_path_runtime('../lib')

  for name in tests:
    test = drake.cxx.Executable(
      'tests/%s' % name,
      (
        drake.node('tests/%s.cc' % name),
        library,
        elle_library,
        reactor_library,
        reactor.library_coroutine,
        cryptography_library,
      ),
      cxx_toolkit,
      cxx_config_tests,
    )
    rule_tests << test
    if valgrind is not None:
      runner = drake.valgrind.ValgrindRunner(exe = test,
                                             valgrind = valgrind)
    else:
      runner = drake.Runner(exe = test)
    runner.reporting = drake.Runner.Reporting.on_failure
    rule_check << runner.status

  # Install
  global rule_install
  rule_install = drake.Rule('install')
  if cxx_toolkit.os != drake.os.windows:
    rule_install << drake.install(lib_dynamic, prefix)
  rule_install << drake.install(lib_static, prefix)
  rule_install << drake.install(
    (node for node in sources if isinstance(node, drake.cxx.Header)),
    prefix / 'include', 'src')