#!/usr/bin/env python3

import os
import subprocess
import sys
import platform

arch, osyst, comp = os.environ['BUILDFARM_NAME'].split('-')

template = '''\
#!/usr/bin/env python3

import os
import os.path
import sys

# Add drake in the Python path.
sys.path.insert(0, os.path.realpath(%(dir_source)r '/drake/src'))

import drake
import drake.cxx
import drake.cxx.boost

os.environ.update(%(environ)r)

cxx_toolkit = drake.cxx.GccToolkit(compiler = %(compiler)r)
cxx_config = drake.cxx.Config()
cxx_config.enable_debug_symbols()
cxx_config.enable_optimization(True)
# Needed on OSX ?
# cxx_config.warnings.overloaded_virtual = False

for f in %(flags)r:
  cxx_config.flag(f)

with drake.Drake(%(dir_source)r) as d:
  boost = drake.cxx.boost.Boost(prefix = %(boost)r,
                                cxx_toolkit = cxx_toolkit,
                                prefer_shared = %(boost_shared)r)
  python = %(python)r
  import drake.valgrind
  if %(valgrind)r:
    valgrind = drake.valgrind.Valgrind()
  else:
    valgrind = None

  d.run(cxx_toolkit,
        cxx_config,
        boost = boost,
        python3 = python,
        valgrind = valgrind)
'''


parameters = {
  'compiler': None,
  'environ': {},
  'flags': (),
  'boost': None,
  'boost_shared': True,
  'python': None,
  'valgrind': False,
}

if osyst.startswith('linux'):
  parameters['boost'] = '/home/buildslave/local'
  parameters['valgrind'] = True
elif osyst == 'osx':
  parameters['compiler'] = 'clang++'
  parameters['environ'] = {'MACOSX_DEPLOYMENT_TARGET': '10.7'}
  parameters['flags'] = ('-ftemplate-depth=512', '-stdlib=libc++')
  parameters['boost'] = '/usr/local'
  parameters['python'] = '/usr/local/Frameworks/Python.framework/Versions/3.4'
elif osyst == 'win64':
  parameters['compiler'] = 'x86_64-w64-mingw32-g++'
  parameters['boost'] = '/usr/local'
  parameters['boost_shared'] = False
else:
  raise Exception('invalid OS: %s' % osyst)


with open('%s/drake' % os.environ['DIR_BUILD'], 'w') as drake:
  parameters['dir_source'] = os.path.abspath(os.environ['DIR_SOURCE'])
  print(template % parameters, file = drake)
